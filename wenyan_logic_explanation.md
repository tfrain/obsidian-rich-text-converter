# `wenyan` 适配 Medium 的最终核心逻辑

您好，这份文档沉淀了我们最终在插件中实现的、用于适配 Medium 的完整工作流程。

我们最终的方案将**预览**和**复制**作为两个独立的过程来处理，以确保您在 Obsidian 中有良好的预览体验，同时在 Medium 中有最可靠的粘贴效果。

---

### 第 1 部分：预览窗格的渲染逻辑

当您打开“Medium 预览”窗格时，您看到的内容是经过以下优化处理的，目的是为了提供一个视觉上准确、美观的预览：

1.  **基础转换**：插件首先使用 `marked.js` 库将您的 Markdown 文本转换为基础 HTML。
2.  **DOM 解析**：程序将生成的 HTML 字符串加载到一个虚拟 DOM 中，以便进行修改。
3.  **预览优化**：
    *   **清理属性**：移除所有 HTML 标签上的 `id` 和 `class` 属性，避免不必要的样式冲突。
    *   **强化标题**：将所有标题标签（`<h1>` 到 `<h6>`）的文本内容用 `<strong>` 标签包裹，使其在预览中视觉上更突出。
    *   **美化代码块**：为代码块的 `<pre>` 标签添加背景色、边距等基础样式，让它在预览时看起来清晰、格式正确，能够正确地显示换行和缩进。

    > **关键点**：在这个阶段，代码块仍然是语义正确的 `<pre>` 标签，没有做任何破坏性的改动。

---

### 第 2 部分：“复制到 Medium”按钮的“魔术”

这是整个插件的核心，也是我们从 `wenyan` 的行为中推导出的最终逻辑。当您点击“复制到 Medium”按钮时，程序会在后台执行一个**专门为 Medium 定制的转换和复制**流程：

1.  **获取预览内容**：程序首先获取当前预览窗格中完整、美观的 HTML 内容。
2.  **为 Medium 动态转换**：接着，它将这份 HTML 在内存中进行一次**“净化”**，专门处理代码块：
    *   **“净化”`<pre>`标签**：程序会找到所有的 `<pre>` 标签，然后执行以下操作：
        *   **保留** `<pre>` 标签本身。
        *   **移除**其内部的所有 `<code>` 标签和我们在预览时添加的 `style` 样式。
        *   最终只留下一个**极其干净、纯粹的 `<pre>...</pre>` 块**，里面是您未经任何修饰的原始代码文本。
    *   **为什么这么做？** Medium 的编辑器在识别粘贴内容时，对于这种干净、语义化的 `<pre>` 标签有最好的兼容性。它会自动将其识别并渲染为格式正确的代码块，从而实现“一键粘贴，格式完美”的效果。其他如标题、段落等元素则保留其 HTML 格式。
3.  **执行富文本复制**：
    *   程序将这份“净化”后的 HTML，通过一个巧妙的技巧（在可见元素上执行复制命令），作为**富文本**复制到您的剪贴板。

### 结论

通过这种**“预览”**和**“复制”**分离的策略，我们最终实现了：
-   **预览时**：内容美观，代码格式正确，符合您在 Obsidian 中的阅读习惯。
-   **复制后**：内容经过特殊处理，能够最大限度地兼容 Medium 编辑器，实现包括代码块在内的所有内容的一键完美粘贴。
